<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaBlox Studio</title>
  <style>
    :root {
      --bg: #f3efe5;
      --panel: #fffaf0;
      --ink: #17212b;
      --muted: #5d6a76;
      --line: #d8cdb8;
      --brand: #006f8f;
      --brand-strong: #005874;
      --safe: #2f8f5b;
      --caution: #b37400;
      --danger: #b02a2a;
      --shadow: 0 12px 34px rgba(23, 33, 43, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Avenir Next", "Trebuchet MS", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 5% 8%, rgba(0, 111, 143, 0.16), transparent 36%),
        radial-gradient(circle at 94% 15%, rgba(237, 146, 63, 0.2), transparent 29%),
        var(--bg);
      min-height: 100vh;
    }

    .shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      gap: 16px;
      grid-template-columns: 1fr;
      animation: rise 360ms ease-out;
    }

    @keyframes rise {
      from {
        transform: translateY(8px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .hero {
      background: linear-gradient(120deg, #005874, #007d8d 52%, #0e8f64);
      color: #f6fbff;
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: var(--shadow);
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(1.4rem, 2.6vw, 2.2rem);
      letter-spacing: 0.01em;
    }

    .hero p {
      margin: 7px 0 0;
      color: #d6effa;
      max-width: 68ch;
      font-size: 0.95rem;
    }

    .grid {
      display: grid;
      gap: 14px;
      grid-template-columns: 1.1fr 0.9fr;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 8px 22px rgba(23, 33, 43, 0.08);
    }

    .panel h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #304253;
    }

    .row {
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr auto;
      align-items: end;
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #445567;
      margin-bottom: 4px;
    }

    input,
    select,
    textarea,
    button {
      font: inherit;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: 1px solid #c6baa2;
      background: #fff;
      color: #1c2a34;
      border-radius: 10px;
      padding: 10px 11px;
      outline: none;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(0, 111, 143, 0.18);
    }

    textarea {
      min-height: 112px;
      resize: vertical;
      line-height: 1.35;
      font-family: "Consolas", "Monaco", monospace;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 13px;
      font-weight: 700;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: transform 120ms ease, filter 120ms ease;
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .btn-primary {
      background: var(--brand);
      color: #f4fbff;
    }

    .btn-secondary {
      background: #dbe6ec;
      color: #203140;
    }

    .btn-good {
      background: #1f8558;
      color: #eefcf3;
    }

    .btn-danger {
      background: #a23838;
      color: #fff6f6;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      background: #e6efe4;
      color: #2d5d3f;
    }

    .pill.warn {
      background: #fbeccc;
      color: #7a4e00;
    }

    .pill.bad {
      background: #f7d9d9;
      color: #7c2121;
    }

    .subtle {
      color: var(--muted);
      font-size: 0.88rem;
      margin-top: 8px;
    }

    .commands {
      display: grid;
      gap: 8px;
      max-height: 440px;
      overflow: auto;
      padding-right: 2px;
    }

    .command {
      border: 1px solid #d7c8af;
      background: #fffcf6;
      border-radius: 10px;
      padding: 8px 9px;
      animation: pop 220ms ease;
    }

    @keyframes pop {
      from {
        transform: scale(0.99);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .command-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
      font-size: 0.86rem;
    }

    .badge {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #fff;
    }

    .risk-safe { background: var(--safe); }
    .risk-caution { background: var(--caution); }
    .risk-dangerous { background: var(--danger); }

    .mono {
      font-family: "Consolas", "Monaco", monospace;
      font-size: 0.78rem;
      color: #3a4a59;
      word-break: break-word;
    }

    .log {
      margin-top: 8px;
      min-height: 88px;
      max-height: 180px;
      overflow: auto;
      border: 1px dashed #c6b89d;
      border-radius: 10px;
      padding: 8px;
      background: #fff;
      font-family: "Consolas", "Monaco", monospace;
      font-size: 0.78rem;
      line-height: 1.35;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .template-chip {
      border: 1px solid #b9c7ce;
      background: #eff4f7;
      color: #1f3442;
      border-radius: 10px;
      padding: 8px;
      text-align: left;
      font-size: 0.8rem;
      line-height: 1.25;
      cursor: pointer;
    }

    .template-chip.active {
      border-color: var(--brand);
      background: #d8ecf2;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.86rem;
      color: #304555;
      margin-top: 6px;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .template-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="shell">
    <section class="hero">
      <h1>NovaBlox Studio</h1>
      <p>Text + voice planner for Roblox scene automation. Generate a plan, inspect risk, then queue commands to the bridge with one click.</p>
    </section>

    <section class="grid">
      <div class="panel">
        <h2>Planner</h2>
        <div class="row">
          <div>
            <label for="apiKey">API Key</label>
            <input id="apiKey" type="password" placeholder="Paste ROBLOXBRIDGE_API_KEY" />
          </div>
          <button id="healthBtn" class="btn-secondary" type="button">Check Health</button>
        </div>

        <div class="row" style="grid-template-columns: 1fr 200px;">
          <div>
            <label for="prompt">Describe What To Build</label>
            <textarea id="prompt" placeholder="Example: Build a 12-platform obby with a neon goal and sunset mood."></textarea>
          </div>
          <div>
            <label for="template">Template</label>
            <select id="template">
              <option value="">Auto Detect</option>
            </select>
            <div class="subtle">Auto maps prompts to obby / terrain / lighting flows.</div>
          </div>
        </div>

        <div class="button-row" style="margin-bottom: 8px;">
          <button id="voiceBtn" class="btn-secondary" type="button">Voice Input</button>
          <button id="planBtn" class="btn-primary" type="button">Generate Plan</button>
          <button id="queueBtn" class="btn-good" type="button">Queue Plan</button>
        </div>

        <div class="toggle">
          <input id="allowDangerous" type="checkbox" />
          <label for="allowDangerous" style="margin: 0; text-transform: none; letter-spacing: 0; font-size: 0.86rem;">Allow dangerous actions (delete/run-command/publish)</label>
        </div>

        <div id="riskRow" class="button-row" style="margin-top: 10px;"></div>

        <div class="template-grid" id="templateCards"></div>
        <div class="subtle">Templates are deterministic and reusable: obstacle course builder, terrain generator, lighting mood presets.</div>

        <div class="log" id="log"></div>
      </div>

      <div class="panel">
        <h2>Plan Preview</h2>
        <div class="subtle" id="planMeta">No plan generated yet.</div>
        <div class="commands" id="commands"></div>
      </div>
    </section>
  </main>

  <script>
    const el = {
      apiKey: document.getElementById("apiKey"),
      healthBtn: document.getElementById("healthBtn"),
      prompt: document.getElementById("prompt"),
      template: document.getElementById("template"),
      templateCards: document.getElementById("templateCards"),
      voiceBtn: document.getElementById("voiceBtn"),
      planBtn: document.getElementById("planBtn"),
      queueBtn: document.getElementById("queueBtn"),
      allowDangerous: document.getElementById("allowDangerous"),
      riskRow: document.getElementById("riskRow"),
      planMeta: document.getElementById("planMeta"),
      commands: document.getElementById("commands"),
      log: document.getElementById("log"),
    };

    const state = {
      templates: [],
      plan: null,
      listening: false,
      recognition: null,
    };

    function log(message, isError = false) {
      const line = document.createElement("div");
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      line.style.color = isError ? "#8a1f1f" : "#20323f";
      el.log.prepend(line);
    }

    function headers() {
      const out = { "Content-Type": "application/json" };
      const key = el.apiKey.value.trim();
      if (key) {
        out["X-API-Key"] = key;
      }
      return out;
    }

    async function fetchJson(path, options = {}) {
      const res = await fetch(path, options);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const msg = data.error || data.message || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    function riskPill(label, count, className = "") {
      const span = document.createElement("span");
      span.className = `pill ${className}`.trim();
      span.textContent = `${label}: ${count}`;
      return span;
    }

    function renderPlan(plan) {
      state.plan = plan;
      el.commands.innerHTML = "";
      el.riskRow.innerHTML = "";

      if (!plan) {
        el.planMeta.textContent = "No plan generated yet.";
        return;
      }

      const risk = plan.risk_summary || { safe: 0, caution: 0, dangerous: 0, max_risk: "safe" };
      el.riskRow.append(
        riskPill("Safe", risk.safe),
        riskPill("Caution", risk.caution, "warn"),
        riskPill("Danger", risk.dangerous, "bad")
      );

      el.planMeta.textContent = `${plan.title} • ${plan.workflow.template} • ${plan.commands.length} commands`;

      plan.commands.forEach((command, index) => {
        const card = document.createElement("article");
        card.className = "command";

        const riskClass = `risk-${command.risk || "safe"}`;
        card.innerHTML = `
          <div class="command-head">
            <strong>${index + 1}. ${command.action}</strong>
            <span class="badge ${riskClass}">${command.risk || "safe"}</span>
          </div>
          <div class="mono">${command.route}</div>
          <div class="subtle">${command.reason || ""}</div>
        `;
        el.commands.appendChild(card);
      });

      if (Array.isArray(plan.warnings) && plan.warnings.length > 0) {
        plan.warnings.forEach((warning) => log(`warning: ${warning}`, true));
      }
    }

    function pickTemplate(id) {
      el.template.value = id || "";
      [...el.templateCards.querySelectorAll("button")].forEach((button) => {
        button.classList.toggle("active", button.dataset.templateId === id);
      });
    }

    async function loadTemplates() {
      try {
        const data = await fetchJson("/bridge/planner/templates", { headers: headers() });
        state.templates = Array.isArray(data.templates) ? data.templates : [];

        el.template.innerHTML = `<option value="">Auto Detect</option>`;
        el.templateCards.innerHTML = "";

        state.templates.forEach((template) => {
          const option = document.createElement("option");
          option.value = template.id;
          option.textContent = template.label;
          el.template.appendChild(option);

          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "template-chip";
          chip.dataset.templateId = template.id;
          chip.textContent = `${template.label}\n${template.description}`;
          chip.addEventListener("click", () => pickTemplate(template.id));
          el.templateCards.appendChild(chip);
        });
      } catch (err) {
        log(`template load failed: ${err.message}`, true);
      }
    }

    async function checkHealth() {
      try {
        const health = await fetchJson("/bridge/health", { headers: headers() });
        const queue = health.queue || {};
        log(`health ok | queued=${queue.pending_count || 0} total=${queue.total_commands || 0}`);
      } catch (err) {
        log(`health failed: ${err.message}`, true);
      }
    }

    async function generatePlan() {
      try {
        const body = {
          prompt: el.prompt.value,
          template: el.template.value || undefined,
          voice_mode: state.listening,
        };
        const data = await fetchJson("/bridge/assistant/plan", {
          method: "POST",
          headers: headers(),
          body: JSON.stringify(body),
        });
        renderPlan(data.plan);
        log(`plan generated: ${data.plan.workflow.template} (${data.plan.commands.length} commands)`);
      } catch (err) {
        log(`plan failed: ${err.message}`, true);
      }
    }

    async function queuePlan() {
      if (!state.plan) {
        log("no plan available to queue", true);
        return;
      }

      try {
        const data = await fetchJson("/bridge/assistant/execute", {
          method: "POST",
          headers: headers(),
          body: JSON.stringify({
            plan: state.plan,
            allow_dangerous: el.allowDangerous.checked,
          }),
        });
        log(`queued ${data.queued_count} commands | deduped=${data.deduped_count}`);
      } catch (err) {
        log(`queue failed: ${err.message}`, true);
      }
    }

    function setupVoice() {
      const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Speech) {
        el.voiceBtn.disabled = true;
        el.voiceBtn.title = "SpeechRecognition API unavailable in this browser";
        return;
      }

      const recognition = new Speech();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";
      state.recognition = recognition;

      recognition.onstart = () => {
        state.listening = true;
        el.voiceBtn.className = "btn-danger";
        el.voiceBtn.textContent = "Listening...";
      };

      recognition.onresult = (event) => {
        const text = (event.results && event.results[0] && event.results[0][0] && event.results[0][0].transcript) || "";
        if (text) {
          el.prompt.value = text;
          log(`voice captured: ${text}`);
        }
      };

      recognition.onerror = (event) => {
        log(`voice error: ${event.error || "unknown"}`, true);
      };

      recognition.onend = () => {
        state.listening = false;
        el.voiceBtn.className = "btn-secondary";
        el.voiceBtn.textContent = "Voice Input";
      };

      el.voiceBtn.addEventListener("click", () => {
        if (state.listening) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });
    }

    el.template.addEventListener("change", () => pickTemplate(el.template.value || ""));
    el.healthBtn.addEventListener("click", checkHealth);
    el.planBtn.addEventListener("click", generatePlan);
    el.queueBtn.addEventListener("click", queuePlan);
    el.apiKey.addEventListener("change", loadTemplates);

    setupVoice();
    loadTemplates();
    checkHealth();
  </script>
</body>
</html>
